{{> layout/header}}
<div class="container p-5" style="max-width: 850px;">
    <div class="card border-0">
        <div class="card-header">
            <h4 class="mb-0"><b>환불 요청 관리</b></h4>
        </div>
        <div class="card-body table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th class="text-center">No</th>
                        <th class="text-center">사용자(Email)</th>
                        <th class="text-center">결제번호</th>
                        <th class="text-center">환불 요청 금액</th>
                        <th class="text-center">요청일시</th>
                        <th class="text-center">상태</th>
                        <th class="text-center">관리</th>
                    </tr>
                </thead>
                <tbody>
                {{#refundList}}
                    <tr>
                        <td class="text-center">{{id}}</td>
                        <td class="text-center">{{username}}</td>
                        <td class="text-center">{{paymentId}}</td>
                        <td class="text-center">{{amount}} P</td>
                        <td class="text-center">{{requestedAt}}</td>
                        <td class="text-center">{{statusDisplay}}</td>
                        <td>
                            <button class="btn btn-outline-secondary btn-sm"
                                    data-bs-toggle="modal" data-bs-target="#myModal"
                            onclick="openRefundModal('{{id}}', '{{username}}', '{{reason}}', {{amount}}, '{{statusDisplay}}')">
                                상세
                            </button>
                        </td>
                    </tr>
                {{/refundList}}
                </tbody>
            </table>
        </div>

        <div class="modal fade" id="myModal">
            <div class="modal-dialog">
                <div class="modal-content">

                    <div class="modal-header">
                        <h4 class="modal-title">환불 요청 상세</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <input type="hidden" id="modalRefundId" value="">
                       <div class="mb-3">
                           <label class="form-label text-muted small">신청자</label>
                           <div class="form-control-plaintext fw-bold" id="modalUsername"></div>
                       </div>
                        <div class="mb-3">
                            <label class="form-label text-muted small">환불 요청 금액</label>
                            <div class="form-control-plaintext fw-bold text-danger" id="modalAmount"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted small">환불 사유</label>
                            <div class="form-control-plaintext fw-normal rounded-2 p-2" id="modalReason" style="background-color: rgb(245, 245, 245);"></div>
                        </div>

                        <div class="mb-3" style="display: none;" id="rejectReasonDiv">
                            <label class="form-label text-muted small">관리자 거절 사유</label>
                            <textarea class="form-control" name="" id="rejectReasonInput" rows="2" placeholder="거절 사유 반드시 입력"></textarea>
                        </div>
                    </div>

                    <div class="modal-footer" id="modalFooter">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function openRefundModal(id, username, reason, amount, statusDisplay) {

        document.getElementById("modalRefundId").value = id;
        document.getElementById("modalUsername").textContent = username;
        document.getElementById("modalReason").textContent = reason ? reason : "(사유없음)";
        document.getElementById("modalAmount").textContent = parseInt(amount).toLocaleString() + ' P';

        const footer = document.getElementById("modalFooter");
        const rejectDiv = document.getElementById("rejectReasonDiv");
        rejectDiv.style.display = 'none';
        document.getElementById("rejectReasonInput").value = "";

        if(statusDisplay === '대기중') {
            footer.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-danger" onclick="toggleRejectInput()">거절</button>
                <button type="button" class="btn btn-primary" onclick="approveRefund(${id})"> 환불 승인</button>
            `;
        } else {
            footer.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                `;
        }
    }

    function toggleRejectInput() {
        const $rejectDiv = document.getElementById("rejectReasonDiv");
        const $footer = document.getElementById("modalFooter");
        const id = document.getElementById("modalRefundId").value;

        $rejectDiv.style.display = 'block';
        $footer.innerHTML = `
             <button type="button" class="btn btn-secondary" onclick="hideRejectInput()">취소</button>
             <button type="button" class="btn btn-danger" onclick="rejectRefund(${id})">거절 확정</button>
        `;
    }

    function rejectRefund(id) {
        const rejectReason = document.getElementById("rejectReasonInput").value.trim();

        if(!rejectReason) {
            alert("거절 사유를 입력해주세요");
            return;
        }

        if(!confirm("환불 요청을 정말로 거절하시겠습니까?")) {
            return;
        }

        const $form = document.createElement('form');
        $form.method = 'POST';
        $form.action = `/admin/refunds/${id}/reject`;

        const $input = document.createElement('input');
        $input.type = "hidden";
        $input.name = "rejectReason";
        $input.value = rejectReason;

        $form.appendChild($input);

        document.body.appendChild($form);

        $form.submit();

    }

    function hideRejectInput() {
        const id = document.getElementById("modalRefundId").value;
        const $rejectDiv = document.getElementById("rejectReasonDiv");
        const $footer = document.getElementById("modalFooter");

        $rejectDiv.style.display = 'none';
        document.getElementById("rejectReasonInput").value = "";

        $footer.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-danger" onclick="toggleRejectInput()">거절</button>
                <button type="button" class="btn btn-primary" onclick="approveRefund(${id})">환불 승인</button>
            `;
    }

    function approveRefund(id) {
        if(!confirm("환불을 승인하시겠습니까?\n(즉시 환불처리됩니다.)")) {
            return;
        }

        const $form = document.createElement("form");
        $form.method = "POST";
        $form.action = `/admin/refunds/${id}/approve`;

        document.body.appendChild($form);
        $form.submit();
    }

</script>
{{> layout/footer}}